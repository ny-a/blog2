{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2020-02/sudo-with-login-option-behavior-of-quote/","result":{"data":{"site":{"siteMetadata":{"title":"Blog"}},"markdownRemark":{"id":"0954da93-9050-55b7-a7ce-6e572148e2a6","excerpt":"コマンドには  オプションがあり、コマンドを走らせるユーザー(デフォルトは root)のログインシェルを\n使ってコマンドを実行できますが、このオプションを指定する場合としない場合でクオートの扱いが変わってハマってしまいました。 具体的には、EC2 の root で実行される user_data…","html":"<p><code class=\"language-text\">sudo</code> コマンドには <code class=\"language-text\">-i/--login</code> オプションがあり、コマンドを走らせるユーザー(デフォルトは root)のログインシェルを\n使ってコマンドを実行できますが、このオプションを指定する場合としない場合でクオートの扱いが変わってハマってしまいました。</p>\n<p>具体的には、EC2 の root で実行される user_data スクリプトで、 パスフレーズなしのキーペアを生成する際に</p>\n<div class=\"gatsby-highlight\" data-language=\"shellscript\"><pre class=\"language-shellscript\"><code class=\"language-shellscript\">sudo -u ec2-user -i ssh-keygen -f .ssh/id_rsa -N &#39;&#39;</code></pre></div>\n<p>とすると、 <code class=\"language-text\">option requires an argument -- N</code> というエラーが発生してしまいます。</p>\n<p>(ちなみにここで生成したキーペアは、 git clone をするための deploy key として使おうとしています。\nuser<em>data とはいえ private key を含めたくなかったので、インスタンスで生成して public key を登録する形にしました。\n結局 API を叩くときなどに使用する token/secret は user</em>data に含めることになるんですが……)</p>\n<h2>issues</h2>\n<p>この問題ズバリの issue が5年前に出ていますが、1つもコメントはついていません。\n<a href=\"https://bugzilla.sudo.ws/show_bug.cgi?id=679\">Bug 679 - sudo -i ignores empty arguments</a></p>\n<p>10 年前の\n<a href=\"https://bugzilla.sudo.ws/show_bug.cgi?id=413\">Bug 413 - Unexpected change in quoting behaviour with -i flag</a>\nも同じ問題を指しているように読めますが、こちらも1ヶ月経たずに放置されてしまっています。</p>\n<h2>workaround</h2>\n<p>とりあえずの解決策としては、\n<a href=\"https://bugzilla.sudo.ws/show_bug.cgi?id=679\">#679</a>\nにある stackoverflow へのリンク\n<a href=\"https://stackoverflow.com/questions/27892812/passing-empty-arguments-to-sudo-i\">Passing empty arguments to sudo -i</a>\nにある通り、 <code class=\"language-text\">sudo -i sh -c &#39;foo &quot;bar&quot; &quot;&quot;&#39;</code> などとすればうまく動くようです。</p>\n<p>ただ、あまり嬉しい見た目ではないので、私は <code class=\"language-text\">-i</code> オプションを使わないで、\n<code class=\"language-text\">sudo -u ec2-user ssh-keygen -f /home/ec2-user/.ssh/id_rsa -N &#39;&#39;</code>\nとすることにしました。</p>\n<p><code class=\"language-text\">sudo</code> がデファクトスタンダードのようなものと認識していて、何の疑問もなく使っていたのですが、\n脆弱性の問題なども見かけるので <code class=\"language-text\">doas</code> なども使ってみようかなと思いました。</p>","frontmatter":{"title":"sudoに-iオプションをつけるとクオートの挙動が変わってハマりました","date":"February 29, 2020"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"2020-02/sudo-with-login-option-behavior-of-quote/","previous":{"fields":{"slug":"2020-02/github-dependabot/"},"frontmatter":{"title":"GitHubのdependabotにPRをもらったのでマージしました"}},"next":null}}}